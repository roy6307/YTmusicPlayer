<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Youtube Music Player</title>
  </head>
  <body>

    <script>

      var data = new Object;
      var request = require("request"),
      ytdl = require("ytdl-core"),
      fs = require("fs");
      var selected = "";
      var IsPlaying = false;
      var audio = new Audio();
      
      audio.volume = 0.5;
      audio.currentTime = 0;
      //const {Howl, Howler} = require('howler');
      
      audio.addEventListener('ended',function(){

        audio.pause();
        audio.currentTime = 0;
        IsPlaying = false;
        selected = "";

      });

      function search() {

        return new Promise(function(e, t) {

          var r = document.getElementById("search_bar").value,
              a = "https://www.googleapis.com/youtube/v3/search?q=" + (r = encodeURI(r)) + "&part=snippet&key=AIzaSyDikf229xNW2Rp8WpCky8Ozdh4hb8Q_6qI&maxResults=10";

          var n = new Array,
              s = new Array,
              i = new Array;

          request(a, function(t, r, a) {
            var u = JSON.parse(a).items;
            LEN = Object.keys(u).length;

            for (var o = 0; o < LEN; o++){

              n.push(u[o].id.videoId);
              s.push(u[o].snippet.title);
              i.push(u[o].snippet.thumbnails);

            }

            data.Titles = s;
            data.Ids = n;
            data.Thumbnails = i;

            e();

          });
        })
      }

      function MusicDownload(e, t, n) { //e link     t:mode true or false (fast and slow) n name

        return new Promise(function(r, a) {

          var v;
          "true" == t ? ((v = ytdl(e)).pipe(fs.createWriteStream(n)), v.on("end", () => {
            r()
          })) : ((v = ytdl(e, {
            filter: "audioonly"
          })).pipe(fs.createWriteStream(n)), v.on("end", () => {
            r()
          }));

        })
      }

      function clicked(id, name) {

        if(selected != id+".mp3"){

          MusicDownload("https://www.youtube.com/watch?v="+id,true,id+".mp3").then(() => {
            document.getElementById('name_display').innerHTML = name;
            selected = id+".mp3";

          });
        }

      }

      function insert(e) {

        for (var t = 0; t < Object.keys(e.Titles).length; t++) {

          var n = "video" + (t + 1),
              i = '<input type="image" src="' + e.Thumbnails[t].medium.url + '" style="padding-bottom: 4px; width: 132px; height: 77px; float: left;" onclick="clicked(\'' + e.Ids[t] + '\',\''+e.Titles[t]+'\')">',
              l = 'text' + (t + 1),
              o = '<textarea style="display: inline-block; height: 71px; width: 383px; word-break:normal;">' + e.Titles[t] + '</textarea>';
          document.getElementById(l).innerHTML = o, document.getElementById(n).innerHTML = i
        
        }
      }

      function play(){

        if(IsPlaying == true && selected != "" && audio.currentTime != 0){ //play to pause

          console.log(1);
          audio.pause();
          IsPlaying = false;

          return;

        }

        if(IsPlaying == false && selected == "" && audio.currentTime == 0){ //재생이 끝나있음

          console.log(2);
          console.log("plz select a song!");

          return;

        }

        if(IsPlaying == false && selected != "" && audio.currentTime != 0){ //pause to play

          console.log(3);
          audio.play();
          IsPlaying = true;

          return;

        }

        if(IsPlaying == false && selected != "" && audio.currentTime == 0){ //selected, but not playing

          console.log(4);
          audio.src = './' + selected;
          audio.play();
          IsPlaying = true;

          return;

        }

      }
      
      function vol(num){
        audio.volume = num/100;
      }

      </script>

      <style>

        .imgs{
          float: left;
        }
        .texts{
          padding-left: 7px;
          display: inline-block;
        }

      </style>

    <div class="main_div" style="background-color: blueviolet;">

      <p><input id="search_bar" type="text" value="Search bar..." /> <input name="btn_search" type="button" value="search!" onclick="search().then(() => insert(data))"/></p>

      <div style="overflow: auto; background-color: brown; height: 162px;">
        
        <div class="imgs">

          <div id="video1"></div>
          <div id="video2"></div>
          <div id="video3"></div>
          <div id="video4"></div>
          <div id="video5"></div>
          <div id="video6"></div>
          <div id="video7"></div>
          <div id="video8"></div>
          <div id="video9"></div>
          <div id="video10"></div>

        </div>

        <div class="texts">

          <div id="text1"></div>
          <div id="text2"></div>
          <div id="text3"></div>
          <div id="text4"></div>
          <div id="text5"></div>
          <div id="text6"></div>
          <div id="text7"></div>
          <div id="text8"></div>
          <div id="text9"></div>
          <div id="text10"></div>

        </div>

      </div>

    </div>

      <div style="width: 556px; height: 50px;">

        <div id="name_display" style="float: left; width: 330.7px; height: 51px;">
        
        </div>

        <div style="display: inline-block;">
          
          <input type="range" min="0" max="100" value="50" oninput="vol(this.value)">

        </div>

        <div class="bottom" style="display: inline-block; padding-top: 7px;">
          
          <input type="image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAIAAAADnC86AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAA4SURBVFhH7c0xEQAgDAAxjNS/AixVBy6eJXfZc+7OF+KMOCPOiDPijDgjzogz4ow4I86IM+LIzgPUo76XMlLF1AAAAABJRU5ErkJggg==" id="playing" onclick="play()">

        </div>

      </div>

    </div>

  </body>
</html>