<!DOCTYPE html>
<html style="background-color: #36393F;">

<head>
    <meta charset="UTF-8">
    <title>Youtube Music Player</title>
    <link rel="stylesheet" href="./design.css" type="text/css">
</head>

<body>

    <script>

        var data = new Object;
        var request = require("request"),
            ytdl = require("ytdl-core"),
            fs = require("fs");
        var selected = "";
        var IsPlaying = false;
        var audio = new Audio();
        const {shell} = require('electron');
        const remote = require('electron').remote;
        const currentWindow = remote.getCurrentWindow(); 
        var compare;
        var IT = false;

        document.addEventListener("DOMContentLoaded",_init);

        audio.currentTime = 0;

        function _init(){

            console.log("Loading...");

            LoadBar();
            drawing();

            fs.readFile(__dirname+"/data/settings.json",(err,dataqwer) => {

                var a = JSON.parse(dataqwer);

                audio.volume = a.Volume;

                if(a.API == undefined || a.API == ""){

                    alert("Can't find API key.\nSetting file will be opened.");
                    shell.openItem(__dirname+"/data/settings.json");

                }
            });

            console.log("Done!");

        }

        function drawing(){

            var barlist = document.getElementsByClassName("bar");

            var animate;
            var asdf=1.69;
            var asdf2=2.01;

            document.getElementById('MV').style.height = "1.62%";
            barlist[0].style.width = "1%";
            barlist[1].style.width = "1%";

            animate = setInterval(function(){

                    document.getElementById("MV").style.height =asdf+"%";
                    barlist[0].style.width = asdf2+"%";
                    barlist[1].style.width = asdf2+"%";

                    if(asdf>76.4 || asdf2 > 90.9) {

                        console.log("Clear Interval");
                        document.getElementById("MV").style.height = "76.6%";
                        barlist[0].style.width = "91%";
                        barlist[1].style.width = "91%";
                        document.getElementById("MV").style.overflow = "auto";
                        clearInterval(animate);

                    }

                    asdf = asdf * 1.1;
                    asdf2 = asdf2 * 1.1;

            },19);

            
        }

        function LoadBar(){

            if(IT == true){

                document.getElementById('load_bar').style.display = "inline-block";

            }

            if(IT == false){

                document.getElementById('load_bar').style.display = "none";

            }

        }

        function DoesPress13(evt){

            if (evt.keyCode == 13){

                search().then(() => insert(data));

            }

        }

        function change(){

            var i = audio.currentTime/audio.duration*100;
            var t = "conic-gradient(#a64dff 0% "+i+"%, #595959 0% 100%)";
            document.getElementById('pie').style.background = t;

        }

        function search() {

            return new Promise(function(e, t) {

                fs.readFile(__dirname+"/data/settings.json",(err,dataqwer) => {

                    var a = JSON.parse(dataqwer);

                    if(a.API == undefined){

                        alert("Can't find API key.\nConfig file will be opened.");
                        shell.openItem(__dirname+"/data/settings.json");

                    }else{
                
                        var r = document.getElementById("search_bar").value,
                        a = "https://www.googleapis.com/youtube/v3/search?q=" + encodeURI(r) + "&part=snippet&type=video&key="+a.API+"&maxResults=50";

                        var n = new Array,
                            s = new Array,
                            i = new Array;

                        request(a, function(t, r, b) {
                            var u = JSON.parse(b).items;
                            LEN = Object.keys(u).length;
                            console.log(u)

                            for (var o = 0; o < LEN; o++) {

                                n.push(u[o].id.videoId);
                                s.push(u[o].snippet.title);
                                i.push(u[o].snippet.thumbnails);

                            }

                            data.Titles = s;
                            data.Ids = n;
                            data.Thumbnails = i;

                            e();

                        });
                    }
                })
            
            })
        }

        function MusicDownload(e, t, n) { //e link     t:mode true or false (fast and slow) n name

            return new Promise(function(r, a) {

                if(IT == true){alert("Song is downloading.\nQueue feature will be added.");return;}

                IT = true;
                LoadBar();

                fs.exists(n, (IsExist) => {

                    if(IsExist == true){

                        IT = false;
                        LoadBar();
                        r();

                    }else{

                        var v;
                        true == t ? ((v = ytdl(e)).pipe(fs.createWriteStream(n)), v.on("end", () => {
                            IT = false;
                            LoadBar();
                            r();
                        })) : ((v = ytdl(e, {
                            filter: "audioonly"
                        })).pipe(fs.createWriteStream(n)), v.on("end", () => {
                            IT = false;
                            LoadBar();
                            r();
                        }));

                    }

                });

            })
        }

        function clicked(id, name) {

            if (selected != id + ".mp3") {

                MusicDownload("https://www.youtube.com/watch?v=" + id, true, __dirname+"/data/cache/"+ id + ".mp3").then(() => {
                    document.getElementById('name_display').innerHTML = name;
                    selected = id + ".mp3";

                });
            }

        }

        function insert(e) {

            for (var t = 0; t < Object.keys(e.Titles).length; t++) {

                var n = "video" + (t + 1),
                    i = '<input type="image" src="' + e.Thumbnails[t].medium.url + '" style="padding-bottom: 4px; width: 184.8px; height: 113.4px; float: left;" onclick="clicked(\'' + e.Ids[t] + '\',\'' + e.Titles[t].replace(/(&#39;)/gi,"\\'") + '\')">',
                    l = 'text' + (t + 1),
                    o = '<div style="display: inline-block; height: 112.4px; width: 100%; word-break:normal; margin-left: 10px; margin-top: 5px;" onclick="clicked(\'' + e.Ids[t] + '\',\'' + e.Titles[t].replace(/(&#39;)/gi,"\\'") + '\')">' + e.Titles[t] + '</div>';
                document.getElementById(l).innerHTML = o
                document.getElementById(n).innerHTML = i

            }
        }

        function play() {

            var cen = document.getElementById("pie_center2").style;

            if(IsPlaying == true){

                cen.position = "absolute";
                cen.width = "0px";
                cen.height = "0px";
                cen.borderTop = "12.2px solid transparent";
                cen.borderBottom = "12.2px solid transparent";
                cen.borderRight = "21.13px solid transparent";
                cen.borderLeft = "21.13px solid orange";
                cen.backgroundColor = "";
                cen.top = "7px";
                cen.left = "9.5px";

            }else{

                cen.position = "absolute";
                cen.width = "24.4px";
                cen.height = "24.4px";
                cen.borderTop = "";
                cen.borderBottom = "";
                cen.borderRight = "";
                cen.borderLeft = "";
                cen.backgroundColor = "rgb(153, 153, 153)";
                cen.top = "7px";
                cen.left = "7px";

            }

            compare = ("file:///"+__dirname+"/data/cache/"+selected).replace(/\\/gi,"/");

            if (audio.currentTime != 0 && audio.src != compare){ //재생중 재생

                audio.pause();
                IsPlaying = true;
                audio.currentTime = 0;
                audio.src = __dirname+"/data/cache/"+selected;
                compare = ("file:///"+__dirname+"/data/cache/"+selected).replace(/\\/gi,"/");
                audio.play();

                cen.position = "absolute";
                cen.width = "24.4px";
                cen.height = "24.4px";
                cen.borderTop = "";
                cen.borderBottom = "";
                cen.borderRight = "";
                cen.borderLeft = "";
                cen.backgroundColor = "rgb(153, 153, 153)";
                cen.top = "7px";
                cen.left = "7px";

                return;

            }

            if (IsPlaying == true && audio.currentTime != 0 && audio.src == compare) { //play to pause

                console.log("play to puase")

                audio.pause();
                IsPlaying = false;
                

                return;

            }

            if (IsPlaying == false && audio.currentTime == 0 && audio.src == compare) { //재생이 끝나있음

                alert("Please select a song!");

                return;

            }

            if (IsPlaying == false &&audio.currentTime != 0 && audio.src == compare) { //pause to play

                console.log("Pause to play")

                audio.play();
                IsPlaying = true;

                setInterval(() => {
                    change();
                }, 100);

                return;

            }

            if (IsPlaying == false && audio.currentTime == 0) { //selected, but not playing

                audio.src = __dirname+'/data/cache/' + selected;
                audio.play();
                IsPlaying = true;

                setInterval(() => {
                    change();
                }, 100);

                audio.addEventListener('ended', function() {

                    audio.pause();
                    audio.currentTime = 0;
                    IsPlaying = false;

                    console.log('song end');
                    
                });

                return;

            }

        }

        function vol(num) {
            audio.volume = num / 100;
        }
    </script>

    <style>
        .imgs {
            float: left;
        }
        
        .texts {
            padding-left: 7px;
            display: inline-block;
        }
        
    </style>

            <div id="Frame">

                <div id="Title">Youtube Music Player</div>

                <div id="Dragable"></div>

                <div id="Btn_minimize" onclick="currentWindow.minimize()">

                    <svg height="18" width="18">
                        <polyline points="4.5,13.5 17,13.5" style="fill:none; stroke:gray; stroke-width:1.5"/>
                    </svg>

                </div>

                <div id="Btn_close" onclick="currentWindow.close()">

                    <svg height="18" width="18">
                        <polyline points="6,6 15,15" style="fill:none; stroke:gray; stroke-width:1.5"/>
                        <polyline points="15,6 6,15" style="fill:none; stroke:gray; stroke-width:1.5"/>
                    </svg>

                </div>

            </div>

            <div id="top_bar">
                <input id="search_bar" type="text" value="" onkeypress="DoesPress13(event)"/><div id="load_bar">Downloading</div>
            </div>

            <hr class="bar" width="91%">
            

            <div id="MV">

                <div class="imgs">

                    <div id="video1"></div>
                    <div id="video2"></div>
                    <div id="video3"></div>
                    <div id="video4"></div>
                    <div id="video5"></div>
                    <div id="video6"></div>
                    <div id="video7"></div>
                    <div id="video8"></div>
                    <div id="video9"></div>
                    <div id="video10"></div>
                    <div id="video11"></div>
                    <div id="video12"></div>
                    <div id="video13"></div>
                    <div id="video14"></div>
                    <div id="video15"></div>
                    <div id="video16"></div>
                    <div id="video17"></div>
                    <div id="video18"></div>
                    <div id="video19"></div>
                    <div id="video20"></div>
                    <div id="video21"></div>
                    <div id="video22"></div>
                    <div id="video23"></div>
                    <div id="video24"></div>
                    <div id="video25"></div>
                    <div id="video26"></div>
                    <div id="video27"></div>
                    <div id="video28"></div>
                    <div id="video29"></div>
                    <div id="video30"></div>
                    <div id="video31"></div>
                    <div id="video32"></div>
                    <div id="video33"></div>
                    <div id="video34"></div>
                    <div id="video35"></div>
                    <div id="video36"></div>
                    <div id="video37"></div>
                    <div id="video38"></div>
                    <div id="video39"></div>
                    <div id="video40"></div>
                    <div id="video41"></div>
                    <div id="video42"></div>
                    <div id="video43"></div>
                    <div id="video44"></div>
                    <div id="video45"></div>
                    <div id="video46"></div>
                    <div id="video47"></div>
                    <div id="video48"></div>
                    <div id="video49"></div>
                    <div id="video50"></div>

                </div>

                <div class="texts">

                    <div id="text1"></div>
                    <div id="text2"></div>
                    <div id="text3"></div>
                    <div id="text4"></div>
                    <div id="text5"></div>
                    <div id="text6"></div>
                    <div id="text7"></div>
                    <div id="text8"></div>
                    <div id="text9"></div>
                    <div id="text10"></div>
                    <div id="text11"></div>
                    <div id="text12"></div>
                    <div id="text13"></div>
                    <div id="text14"></div>
                    <div id="text15"></div>
                    <div id="text16"></div>
                    <div id="text17"></div>
                    <div id="text18"></div>
                    <div id="text19"></div>
                    <div id="text20"></div>
                    <div id="text21"></div>
                    <div id="text22"></div>
                    <div id="text23"></div>
                    <div id="text24"></div>
                    <div id="text25"></div>
                    <div id="text26"></div>
                    <div id="text27"></div>
                    <div id="text28"></div>
                    <div id="text29"></div>
                    <div id="text30"></div>
                    <div id="text31"></div>
                    <div id="text32"></div>
                    <div id="text33"></div>
                    <div id="text34"></div>
                    <div id="text35"></div>
                    <div id="text36"></div>
                    <div id="text37"></div>
                    <div id="text38"></div>
                    <div id="text39"></div>
                    <div id="text40"></div>
                    <div id="text41"></div>
                    <div id="text42"></div>
                    <div id="text43"></div>
                    <div id="text44"></div>
                    <div id="text45"></div>
                    <div id="text46"></div>
                    <div id="text47"></div>
                    <div id="text48"></div>
                    <div id="text49"></div>
                    <div id="text50"></div>

                </div>

            </div>

        </div>

        <div style="width: 100%; height: 54px;" id="under">
            
            <hr class="bar" width="91%">

            <div id="name_display">

            </div>

            

            <div style="display: inline-block;">

                <input type="range" id="Volume" min="0" max="100" value="50" oninput="vol(this.value)">

            </div>

            <div class="bottom" style="display: inline-block;">

                <div class="BtnMain" onclick="play()"><div id="pie"style="background: conic-gradient(#a64dff 0% 0%, #595959 0% 100%);"><span class="pie_center"><span id="pie_center2" style="position:absolute;width:0;height:0;border-top:12.2px solid transparent;border-bottom:12.2px solid transparent;border-right:21.13px solid transparent;border-left:21.13px solid orange;top:7px;left:9.5px;"></span></span></div></div>

            </div>

        </div>

</body>

</html>