<!DOCTYPE html>
<html style="background-color: rgb(109, 109, 109);">

<head>
    <meta charset="UTF-8">
    <title>Youtube Music Player</title>
    <link rel="stylesheet" href="./design.css" type="text/css">
</head>

<body>

    <script>

        var data = new Object;
        var request = require("request"),
            ytdl = require("ytdl-core"),
            fs = require("fs");
        var selected = "";
        var IsPlaying = false;
        var audio = new Audio();
        const {shell} = require('electron');
        var compare;
        

        audio.volume = 0.5;
        audio.currentTime = 0;

        fs.readFile(__dirname+"/data/settings.json",(err,dataqwer) => {

            var a = JSON.parse(dataqwer);

            if(a.API == undefined){

                alert("Can't find API key.\nConfig file will be opened.");
                shell.openItem(__dirname+"/data/settings.json");

            }
        });

        function DoesPress13(evt){

            if (evt.keyCode == 13){

                search().then(() => insert(data));

            }

        }

        function change(){

            var i = audio.currentTime/audio.duration*100;
            var t = "conic-gradient(#a64dff 0% "+i+"%, #595959 0% 100%)";
            document.getElementById('pie').style.background = t;

        }

        function search() {

            return new Promise(function(e, t) {

                fs.readFile(__dirname+"/data/settings.json",(err,dataqwer) => {

                    var a = JSON.parse(dataqwer);

                    if(a.API == undefined){

                        alert("Can't find API key.\nConfig file will be opened.");
                        shell.openItem(__dirname+"/data/settings.json");

                    }else{
                
                        var r = document.getElementById("search_bar").value,
                        a = "https://www.googleapis.com/youtube/v3/search?q=" + encodeURI(r) + "&part=snippet&key="+a.API+"&maxResults=10";

                        var n = new Array,
                            s = new Array,
                            i = new Array;

                        request(a, function(t, r, a) {
                            var u = JSON.parse(a).items;
                            LEN = Object.keys(u).length;

                            for (var o = 0; o < LEN; o++) {

                                n.push(u[o].id.videoId);
                                s.push(u[o].snippet.title);
                                i.push(u[o].snippet.thumbnails);

                            }

                            data.Titles = s;
                            data.Ids = n;
                            data.Thumbnails = i;

                            e();

                        });
                    }
                })
            
            })
        }

        function MusicDownload(e, t, n) { //e link     t:mode true or false (fast and slow) n name

            return new Promise(function(r, a) {

                fs.exists(n, (IsExist) => {

                    if(IsExist == true){

                        r();

                    }else{

                        var v;
                        true == t ? ((v = ytdl(e)).pipe(fs.createWriteStream(n)), v.on("end", () => {
                            r();
                        })) : ((v = ytdl(e, {
                            filter: "audioonly"
                        })).pipe(fs.createWriteStream(n)), v.on("end", () => {
                            r();
                        }));

                    }

                });

            })
        }

        function clicked(id, name) {

            if (selected != id + ".mp3") {

                MusicDownload("https://www.youtube.com/watch?v=" + id, true, __dirname+"/data/cache/"+ id + ".mp3").then(() => {
                    document.getElementById('name_display').innerHTML = name;
                    selected = id + ".mp3";

                });
            }

        }

        function insert(e) {

            for (var t = 0; t < Object.keys(e.Titles).length; t++) {

                var n = "video" + (t + 1),
                    i = '<input type="image" src="' + e.Thumbnails[t].medium.url + '" style="padding-bottom: 4px; width: 132px; height: 77px; float: left;" onclick="clicked(\'' + e.Ids[t] + '\',\'' + e.Titles[t].replace(/(&#39;)/gi,"\\'") + '\')">',
                    l = 'text' + (t + 1),
                    o = '<div style="display: inline-block; height: 81px; width: 383px; word-break:normal;" onclick="clicked(\'' + e.Ids[t] + '\',\'' + e.Titles[t].replace(/(&#39;)/gi,"\\'") + '\')">' + e.Titles[t] + '</div>';
                document.getElementById(l).innerHTML = o, document.getElementById(n).innerHTML = i

            }
        }

        function play() {

            compare = ("file:///"+__dirname+"/data/cache/"+selected).replace(/\\/gi,"/")

            if (selected != "" && audio.currentTime != 0 && audio.src != compare){ //재생중 재생

                IsPlaying = false;
                audio.currentTime = 0;
                audio.src = __dirname+"/data/cache/"+selected;
                play();

            }

            if (IsPlaying == true && selected != "" && audio.currentTime != 0 && audio.src == compare) { //play to pause

                audio.pause();
                IsPlaying = false;
                

                return;

            }

            if (IsPlaying == false && selected == "" && audio.currentTime == 0 && audio.src == compare) { //재생이 끝나있음

                alert("Please select a song!");

                return;

            }

            if (IsPlaying == false && selected != "" && audio.currentTime != 0 && audio.src == compare) { //pause to play

                audio.play();
                IsPlaying = true;

                setInterval(() => {
                    change();
                }, 100);

                return;

            }

            if (IsPlaying == false && selected != "" && audio.currentTime == 0) { //selected, but not playing

                audio.src = __dirname+'/data/cache/' + selected;
                audio.play();
                IsPlaying = true;

                setInterval(() => {
                    change();
                }, 100);

                audio.addEventListener('ended', function() {

                    audio.pause();
                    audio.currentTime = 0;
                    IsPlaying = false;

                    selected = "";
                    console.log('song end');
                    

                });

                return;

            }

        }

        function vol(num) {
            audio.volume = num / 100;
        }
    </script>

    <style>
        .imgs {
            float: left;
        }
        
        .texts {
            padding-left: 7px;
            display: inline-block;
        }
        
    </style>
    <div class="real_main_div">
        <div class="main_div">

            <div id="top_bar">
                <input id="search_bar" type="text" value="" onkeypress="DoesPress13(event)"/>
                <input id="btn_search" type="button" value="search!" onclick="search().then(() => insert(data))" />
            </div>

            <div style="overflow: auto; height: 162px;">

                <div class="imgs">

                    <div id="video1"></div>
                    <div id="video2"></div>
                    <div id="video3"></div>
                    <div id="video4"></div>
                    <div id="video5"></div>
                    <div id="video6"></div>
                    <div id="video7"></div>
                    <div id="video8"></div>
                    <div id="video9"></div>
                    <div id="video10"></div>

                </div>

                <div class="texts">

                    <div id="text1"></div>
                    <div id="text2"></div>
                    <div id="text3"></div>
                    <div id="text4"></div>
                    <div id="text5"></div>
                    <div id="text6"></div>
                    <div id="text7"></div>
                    <div id="text8"></div>
                    <div id="text9"></div>
                    <div id="text10"></div>

                </div>

            </div>

        </div>

        <div style="width: 556px; height: 54px;" id="under">

            <div id="name_display" style="float: left; width: 330.7px; height: 51px;">

            </div>

            <div style="display: inline-block;">

                <input type="range" min="0" max="100" value="50" oninput="vol(this.value)">

            </div>

            <div class="bottom" style="display: inline-block;">

                <div class="BtnMain" onclick="play()"><div id="pie"style="background: conic-gradient(#a64dff 0% 0%, #595959 0% 100%);"><span class="pie_center"><span class="pie_center2"></span></span></div></div>

            </div>

        </div>

    </div>
    </div>

</body>

</html>